<!-- Editor Header -->
<header class="editor-header">
  <div class="editor-header-left">
    <%= link_to admin_page_path(@page), class: "editor-back" do %>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
      Back
    <% end %>
    <div class="editor-title"><%= @page.title %></div>
  </div>

  <div class="editor-header-center">
    <button class="device-btn active" data-device="desktop" title="Desktop">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
        <line x1="8" y1="21" x2="16" y2="21"/>
        <line x1="12" y1="17" x2="12" y2="21"/>
      </svg>
    </button>
    <button class="device-btn" data-device="tablet" title="Tablet">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
        <line x1="12" y1="18" x2="12.01" y2="18"/>
      </svg>
    </button>
    <button class="device-btn" data-device="mobile" title="Mobile">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
        <line x1="12" y1="18" x2="12.01" y2="18"/>
      </svg>
    </button>
  </div>

  <div class="editor-header-right">
    <button class="header-btn header-btn-secondary" id="btn-toggle-left" title="Toggle Left Panel">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <line x1="9" y1="3" x2="9" y2="21"/>
      </svg>
    </button>
    <button class="header-btn header-btn-secondary" id="btn-toggle-right" title="Toggle Right Panel">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <line x1="15" y1="3" x2="15" y2="21"/>
      </svg>
    </button>
    <div class="header-separator"></div>
    <button class="header-btn header-btn-secondary" id="btn-undo" title="Undo (Ctrl+Z)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 7v6h6"/>
        <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
      </svg>
    </button>
    <button class="header-btn header-btn-secondary" id="btn-redo" title="Redo (Ctrl+Y)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 7v6h-6"/>
        <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
      </svg>
    </button>
    <button class="header-btn header-btn-secondary" id="btn-preview" title="Preview">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
      Preview
    </button>
    <button class="header-btn header-btn-secondary" id="btn-code" title="View Code">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="16 18 22 12 16 6"/>
        <polyline points="8 6 2 12 8 18"/>
      </svg>
      Code
    </button>
    <button class="header-btn header-btn-primary" id="btn-save">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
        <polyline points="17 21 17 13 7 13 7 21"/>
        <polyline points="7 3 7 8 15 8"/>
      </svg>
      Save
    </button>
  </div>
</header>

<!-- Main Editor -->
<div class="editor-wrapper">
  <div class="editor-main">
    <div class="editor-container">
      <!-- Left Panel: Blocks -->
      <div class="editor-panel-left" id="panel-left">
        <div class="panel-tabs">
          <button class="panel-tab active" data-panel="blocks">Blocks</button>
          <button class="panel-tab" data-panel="layers">Layers</button>
        </div>
        <div class="panel-content">
          <div id="blocks-container"></div>
          <div id="layers-container" style="display: none;"></div>
        </div>
      </div>

      <!-- Canvas -->
      <div class="editor-canvas">
        <div id="gjs"></div>
      </div>

      <!-- Right Panel: Styles/Settings -->
      <div class="editor-panel-right" id="panel-right">
        <div class="panel-tabs">
          <button class="panel-tab active" data-panel="styles">Styles</button>
          <button class="panel-tab" data-panel="settings">Settings</button>
        </div>
        <div class="panel-content">
          <div id="styles-container"></div>
          <div id="traits-container" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Panel: Code Editor -->
  <div class="editor-code-panel" id="code-panel">
    <div class="code-panel-header">
      <div class="code-panel-tabs">
        <button class="code-panel-tab active" data-type="html">HTML</button>
        <button class="code-panel-tab" data-type="css">CSS</button>
        <button class="code-panel-tab" data-type="js">JavaScript</button>
      </div>
      <div class="code-panel-mode" id="code-panel-mode" style="display: none;">
        <span class="mode-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          </svg>
          <span id="component-name">Component</span>
        </span>
        <button class="code-panel-btn" id="code-full-page" title="Switch to full page">Full Page</button>
      </div>
      <div class="code-panel-actions">
        <span id="code-status" class="code-status synced">Synced</span>
        <button class="code-panel-btn" id="code-format" title="Format (Ctrl+Shift+F)">Format</button>
        <button class="code-panel-btn primary" id="code-apply" title="Apply (Ctrl+S)">Apply</button>
        <button class="code-panel-btn" id="code-close" title="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div class="code-panel-resize" id="code-panel-resize"></div>
    <div class="code-panel-content">
      <div id="monaco-html-container" class="monaco-container"></div>
      <div id="monaco-css-container" class="monaco-container" style="display: none;"></div>
      <div id="monaco-js-container" class="monaco-container" style="display: none;"></div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="editor-toast" class="editor-toast"></div>

<!-- Loading Overlay -->
<div id="editor-loading" class="editor-loading hidden">
  <div class="editor-loading-spinner"></div>
</div>

<style>
  .header-separator {
    width: 1px;
    height: 24px;
    background: var(--editor-border);
    margin: 0 0.25rem;
  }

  .editor-panel-left,
  .editor-panel-right {
    transition: width 0.2s ease, min-width 0.2s ease, opacity 0.2s ease, border-width 0.2s ease;
    overflow: hidden;
  }

  .editor-panel-left.collapsed,
  .editor-panel-right.collapsed {
    width: 0 !important;
    min-width: 0 !important;
    padding: 0 !important;
    opacity: 0;
    pointer-events: none;
    border-width: 0 !important;
  }

  #btn-toggle-left.active,
  #btn-toggle-right.active {
    background: var(--editor-primary);
    color: white;
  }

  #btn-code.active {
    background: var(--editor-primary);
    color: white;
  }

  /* Editor wrapper for vertical layout */
  .editor-wrapper {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 50px);
    margin-top: 50px;
  }

  .editor-main {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }

  .editor-container {
    flex: 1;
    display: flex;
    min-height: 0;
    overflow: hidden;
  }

  /* Bottom Code Panel */
  .editor-code-panel {
    height: 300px;
    min-height: 150px;
    max-height: 70vh;
    background: #1e1e1e;
    border-top: 1px solid var(--editor-border);
    display: none;
    flex-direction: column;
    flex-shrink: 0;
    position: relative;
  }

  .editor-code-panel.open {
    display: flex;
  }

  .code-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 0.75rem;
    background: #252526;
    border-bottom: 1px solid #3d3d3d;
    height: 36px;
    flex-shrink: 0;
  }

  .code-panel-tabs {
    display: flex;
    gap: 0;
  }

  .code-panel-tab {
    padding: 0.5rem 1rem;
    background: transparent;
    border: none;
    color: #999;
    font-size: 0.75rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
  }

  .code-panel-tab:hover {
    color: #e5e5e5;
  }

  .code-panel-tab.active {
    color: #e5e5e5;
    border-bottom-color: #3b82f6;
  }

  .code-panel-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .code-status {
    font-size: 0.6875rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
  }

  .code-status.synced {
    color: #22c55e;
  }

  .code-status.modified {
    color: #f59e0b;
  }

  .code-panel-btn {
    padding: 0.25rem 0.625rem;
    background: #3d3d3d;
    color: #e5e5e5;
    border: none;
    border-radius: 0.25rem;
    font-size: 0.6875rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .code-panel-btn:hover {
    background: #4d4d4d;
  }

  .code-panel-btn.primary {
    background: #3b82f6;
    color: white;
  }

  .code-panel-btn.primary:hover {
    background: #2563eb;
  }

  .code-panel-resize {
    height: 4px;
    background: #252526;
    cursor: ns-resize;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
  }

  .code-panel-resize:hover {
    background: #3b82f6;
  }

  .code-panel-content {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  .monaco-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  /* Component mode styles */
  .code-panel-mode {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-left: 1rem;
    padding-left: 1rem;
    border-left: 1px solid #3d3d3d;
  }

  .mode-badge {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.625rem;
    background: #7c3aed;
    color: white;
    border-radius: 0.25rem;
    font-size: 0.6875rem;
    font-weight: 500;
  }

  .mode-badge svg {
    opacity: 0.8;
  }

  /* GrapeJS toolbar code button */
  .gjs-toolbar .gjs-toolbar-item[data-command="edit-component-code"] {
    order: -1;
  }

  .gjs-toolbar .gjs-toolbar-item .fa-code {
    font-size: 12px;
  }

  /* Highlight code button on hover */
  .gjs-toolbar .gjs-toolbar-item:hover .fa-code {
    color: var(--editor-primary);
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const pageId = <%= @page.id %>;
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  const saveUrl = '<%= save_editor_admin_page_path(@page) %>';
  const mediaUrl = '<%= admin_media_path(format: :json) %>';
  const uploadUrl = '<%= admin_media_path %>';

  // Existing page content
  const existingContent = <%= raw (@page.content || '').to_json %>;
  const existingCss = <%= raw (@page.content_css || '').to_json %>;
  const existingJs = <%= raw (@page.content_js || '').to_json %>;
  const existingComponentsRaw = <%= raw (@page.content_components || '').to_json %>;

  // Parse components JSON if available, otherwise use HTML content
  let componentsToLoad = existingContent || '';
  if (existingComponentsRaw) {
    try {
      componentsToLoad = JSON.parse(existingComponentsRaw);
    } catch (e) {
      console.warn('Could not parse components JSON, falling back to HTML content');
      componentsToLoad = existingContent || '';
    }
  }

  // CSS framework configuration (from database settings)
  const cssFramework = '<%= ActiveCanvas::Setting.css_framework %>';
  const cssFrameworkUrl = <%= raw (ActiveCanvas::Setting.css_framework_url || '').to_json %>;
  const cssFrameworkType = '<%= ActiveCanvas::Setting.css_framework_type %>';
  const globalCss = <%= raw (ActiveCanvas::Setting.global_css || '').to_json %>;
  const globalJs = <%= raw (ActiveCanvas::Setting.global_js || '').to_json %>;

  // Determine canvas configuration based on framework
  let canvasStyles = [];
  let canvasScripts = [];

  if (cssFrameworkUrl) {
    if (cssFrameworkType === 'script') {
      canvasScripts.push(cssFrameworkUrl);
    } else if (cssFrameworkType === 'stylesheet') {
      canvasStyles.push(cssFrameworkUrl);
    }
  }

  // Initialize GrapeJS
  const editor = grapesjs.init({
    container: '#gjs',
    height: '100%',
    width: 'auto',
    fromElement: false,

    // Load existing content
    components: componentsToLoad,
    style: existingCss || '',

    // Storage - we'll handle saving manually
    storageManager: false,

    // Device Manager
    deviceManager: {
      devices: [
        { name: 'Desktop', width: '' },
        { name: 'Tablet', width: '768px', widthMedia: '992px' },
        { name: 'Mobile', width: '320px', widthMedia: '480px' }
      ]
    },

    // Panels - we'll use custom panels
    panels: { defaults: [] },

    // Block Manager
    blockManager: {
      appendTo: '#blocks-container'
    },

    // Layer Manager
    layerManager: {
      appendTo: '#layers-container'
    },

    // Style Manager
    styleManager: {
      appendTo: '#styles-container',
      sectors: [
        {
          name: 'Dimension',
          open: true,
          buildProps: ['width', 'min-width', 'max-width', 'height', 'min-height', 'max-height', 'padding', 'margin']
        },
        {
          name: 'Typography',
          open: false,
          buildProps: ['font-family', 'font-size', 'font-weight', 'letter-spacing', 'color', 'line-height', 'text-align', 'text-decoration', 'text-shadow']
        },
        {
          name: 'Decorations',
          open: false,
          buildProps: ['background-color', 'border-radius', 'border', 'box-shadow']
        },
        {
          name: 'Extra',
          open: false,
          buildProps: ['opacity', 'transition', 'transform']
        }
      ]
    },

    // Trait Manager
    traitManager: {
      appendTo: '#traits-container'
    },

    // Selector Manager
    selectorManager: {
      appendTo: '#styles-container',
      componentFirst: true
    },

    // Asset Manager
    assetManager: {
      uploadName: 'media[file]',
      uploadFile: function(e) {
        const files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
        const formData = new FormData();

        for (let i = 0; i < files.length; i++) {
          formData.append('media[file]', files[i]);
          formData.append('media[filename]', files[i].name);
        }

        fetch(uploadUrl, {
          method: 'POST',
          headers: {
            'X-CSRF-Token': csrfToken
          },
          body: formData
        })
        .then(response => response.json())
        .then(result => {
          if (result.src) {
            editor.AssetManager.add(result);
            showToast('Image uploaded successfully', 'success');
          } else if (result.errors) {
            showToast(result.errors.join(', '), 'error');
          }
        })
        .catch(error => {
          showToast('Upload failed', 'error');
          console.error('Upload error:', error);
        });
      },
      assets: []
    },

    // Canvas - use scripts for Tailwind, styles for others
    canvas: {
      styles: canvasStyles,
      scripts: canvasScripts
    },

    // Plugins
    plugins: [
      'gjs-blocks-basic',
      'grapesjs-plugin-forms',
      'grapesjs-preset-webpage',
      'grapesjs-style-bg',
      'grapesjs-tabs',
      'grapesjs-custom-code',
      'grapesjs-touch',
      'grapesjs-parser-postcss',
      'grapesjs-tooltip',
      'grapesjs-typed'
    ],

    pluginsOpts: {
      'gjs-blocks-basic': {
        flexGrid: true,
        stylePrefix: 'gjs-'
      },
      'grapesjs-plugin-forms': {},
      'grapesjs-preset-webpage': {
        modalImportTitle: 'Import Template',
        modalImportLabel: '<div style="margin-bottom: 10px; font-size: 13px;">Paste your HTML/CSS here</div>',
        modalImportContent: function(editor) {
          return editor.getHtml() + '<style>' + editor.getCss() + '</style>';
        }
      },
      'grapesjs-tabs': {
        tabsBlock: { category: 'Extra' }
      },
      'grapesjs-typed': {
        block: {
          category: 'Extra',
          content: {
            type: 'typed',
            'type-speed': 40,
            strings: ['Text row one', 'Text row two', 'Text row three']
          }
        }
      }
    }
  });

  // Add custom blocks
  addCustomBlocks(editor);

  // Load existing assets
  loadAssets();

  // --- Component Code Editing ---
  // Add code button to component toolbar
  editor.on('component:selected', (component) => {
    if (!component) return;

    let toolbar = component.get('toolbar') || [];

    // Ensure toolbar is an array
    if (!Array.isArray(toolbar)) {
      toolbar = [];
    }

    // Check if code button already exists
    const hasCodeBtn = toolbar.some(item => item.command === 'edit-component-code');

    if (!hasCodeBtn) {
      toolbar.unshift({
        attributes: { class: 'fa-solid fa-code', title: 'Edit Code' },
        command: 'edit-component-code'
      });
      component.set('toolbar', toolbar);
    }
  });

  // Add command for editing component code
  editor.Commands.add('edit-component-code', {
    run(editor) {
      const selected = editor.getSelected();
      if (!selected) return;

      openComponentCodeEditor(selected);
    }
  });

  // Inject global and page-specific CSS/JS into canvas when it's ready
  editor.on('load', () => {
    setTimeout(() => {
      const frame = editor.Canvas.getFrameEl();
      if (!frame || !frame.contentDocument) return;

      // Inject global CSS
      if (globalCss && globalCss.trim()) {
        const globalStyle = frame.contentDocument.createElement('style');
        globalStyle.id = 'active-canvas-global-css';
        globalStyle.textContent = globalCss;
        frame.contentDocument.head.appendChild(globalStyle);
      }

      // Inject global JS
      if (globalJs && globalJs.trim()) {
        const globalScript = frame.contentDocument.createElement('script');
        globalScript.id = 'active-canvas-global-js';
        globalScript.textContent = globalJs;
        frame.contentDocument.body.appendChild(globalScript);
      }

      // Inject page-specific JS
      if (existingJs && existingJs.trim()) {
        const script = frame.contentDocument.createElement('script');
        script.id = 'active-canvas-custom-js';
        script.textContent = existingJs;
        frame.contentDocument.body.appendChild(script);
      }
    }, 500);
  });

  // --- Panel Toggle ---
  const panelLeft = document.getElementById('panel-left');
  const panelRight = document.getElementById('panel-right');
  const btnToggleLeft = document.getElementById('btn-toggle-left');
  const btnToggleRight = document.getElementById('btn-toggle-right');

  function refreshEditor() {
    // Wait for CSS transition to complete, then refresh editor
    setTimeout(() => {
      editor.refresh();
    }, 250);
  }

  btnToggleLeft.addEventListener('click', function() {
    panelLeft.classList.toggle('collapsed');
    this.classList.toggle('active', panelLeft.classList.contains('collapsed'));
    refreshEditor();
  });

  btnToggleRight.addEventListener('click', function() {
    panelRight.classList.toggle('collapsed');
    this.classList.toggle('active', panelRight.classList.contains('collapsed'));
    refreshEditor();
  });

  // --- Panel Tab Switching ---
  document.querySelectorAll('.panel-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const panel = this.dataset.panel;
      const parent = this.closest('.editor-panel-left, .editor-panel-right');

      // Update active tab
      parent.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');

      // Show/hide content
      if (parent.classList.contains('editor-panel-left')) {
        document.getElementById('blocks-container').style.display = panel === 'blocks' ? 'block' : 'none';
        document.getElementById('layers-container').style.display = panel === 'layers' ? 'block' : 'none';
      } else {
        document.getElementById('styles-container').style.display = panel === 'styles' ? 'block' : 'none';
        document.getElementById('traits-container').style.display = panel === 'settings' ? 'block' : 'none';
      }
    });
  });

  // --- Device Switching ---
  document.querySelectorAll('.device-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const device = this.dataset.device;
      document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      const deviceMap = {
        'desktop': 'Desktop',
        'tablet': 'Tablet',
        'mobile': 'Mobile'
      };
      editor.setDevice(deviceMap[device]);
    });
  });

  // --- Undo/Redo ---
  document.getElementById('btn-undo').addEventListener('click', () => {
    editor.UndoManager.undo();
  });

  document.getElementById('btn-redo').addEventListener('click', () => {
    editor.UndoManager.redo();
  });

  // --- Preview ---
  document.getElementById('btn-preview').addEventListener('click', () => {
    editor.runCommand('preview');
  });

  // --- Bottom Code Panel with Monaco Editor ---
  const codePanel = document.getElementById('code-panel');
  const btnCode = document.getElementById('btn-code');
  const statusEl = document.getElementById('code-status');
  const codePanelMode = document.getElementById('code-panel-mode');
  const componentNameEl = document.getElementById('component-name');
  let currentCodeTab = 'html';
  let codeDebounceTimer = null;
  let htmlMonacoEditor = null;
  let cssMonacoEditor = null;
  let jsMonacoEditor = null;
  let monacoInitialized = false;

  // Component editing mode
  let editingComponent = null;  // The GrapeJS component being edited
  let isComponentMode = false;  // Whether we're in component edit mode

  // Initialize Monaco editors
  function initMonacoEditors() {
    if (monacoInitialized) return;

    require(['vs/editor/editor.main'], function() {
      // Define custom dark theme
      monaco.editor.defineTheme('activeCanvasDark', {
        base: 'vs-dark',
        inherit: true,
        rules: [],
        colors: {
          'editor.background': '#1e1e1e',
          'editor.foreground': '#d4d4d4',
          'editorLineNumber.foreground': '#858585',
          'editorCursor.foreground': '#aeafad',
          'editor.selectionBackground': '#264f78',
          'editor.lineHighlightBackground': '#2d2d2d'
        }
      });

      // Common editor options
      const editorOptions = {
        theme: 'activeCanvasDark',
        fontSize: 13,
        lineNumbers: 'on',
        minimap: { enabled: false },
        scrollBeyondLastLine: false,
        automaticLayout: true,
        tabSize: 2,
        wordWrap: 'on',
        folding: true,
        lineDecorationsWidth: 10,
        lineNumbersMinChars: 3,
        renderLineHighlight: 'line',
        scrollbar: {
          verticalScrollbarSize: 10,
          horizontalScrollbarSize: 10
        }
      };

      // Create HTML editor
      htmlMonacoEditor = monaco.editor.create(document.getElementById('monaco-html-container'), {
        value: editor.getHtml(),
        language: 'html',
        ...editorOptions
      });

      // Create CSS editor
      cssMonacoEditor = monaco.editor.create(document.getElementById('monaco-css-container'), {
        value: editor.getCss(),
        language: 'css',
        ...editorOptions
      });

      // Create JS editor
      jsMonacoEditor = monaco.editor.create(document.getElementById('monaco-js-container'), {
        value: existingJs || '',
        language: 'javascript',
        ...editorOptions
      });

      // Live update on content change
      htmlMonacoEditor.onDidChangeModelContent(scheduleCodeUpdate);
      cssMonacoEditor.onDidChangeModelContent(scheduleCodeUpdate);
      jsMonacoEditor.onDidChangeModelContent(scheduleJsUpdate);

      // Add keyboard shortcuts to Monaco
      addMonacoCommands(htmlMonacoEditor);
      addMonacoCommands(cssMonacoEditor);
      addMonacoCommands(jsMonacoEditor);

      monacoInitialized = true;

      // Auto-format on first open
      setTimeout(formatAllCode, 100);
    });
  }

  // Sync GrapeJS content to Monaco editors
  function syncGrapeJSToMonaco() {
    if (!monacoInitialized) return;

    if (isComponentMode && editingComponent) {
      // In component mode, show only the component's HTML
      htmlMonacoEditor.setValue(editingComponent.toHTML());
    } else {
      // Full page mode
      htmlMonacoEditor.setValue(editor.getHtml());
    }
    cssMonacoEditor.setValue(editor.getCss());
    setTimeout(formatAllCode, 50);
  }

  // Update GrapeJS preview from Monaco
  function updatePreviewFromCode() {
    if (!monacoInitialized) return;

    try {
      if (isComponentMode && editingComponent) {
        // In component mode, only update the specific component HTML
        const newHtml = htmlMonacoEditor.getValue();
        updateComponentFromHtml(editingComponent, newHtml);
      } else {
        // Full page mode - update both HTML and CSS
        const newHtml = htmlMonacoEditor.getValue();
        const newCss = cssMonacoEditor.getValue();
        editor.setComponents(newHtml);
        editor.setStyle(newCss);
      }
      statusEl.textContent = 'Synced';
      statusEl.className = 'code-status synced';
    } catch (e) {
      statusEl.textContent = 'Error';
      statusEl.className = 'code-status modified';
      console.error('Code parse error:', e);
    }
  }

  // Update a component from HTML string
  function updateComponentFromHtml(component, html) {
    if (!component) return;

    try {
      // Use GrapeJS replaceWith method to properly replace the component
      const newComponents = component.replaceWith(html);

      if (newComponents && newComponents.length > 0) {
        // Update reference to the new component
        editingComponent = newComponents[0];
        // Select the new component
        editor.select(editingComponent);
      }
    } catch (e) {
      console.error('Error replacing component:', e);
      // Fallback: try updating inner content only
      try {
        component.components(html);
      } catch (e2) {
        console.error('Error updating component content:', e2);
      }
    }
  }

  // Open code panel in component editing mode
  function openComponentCodeEditor(component) {
    editingComponent = component;
    isComponentMode = true;

    // Show component mode UI
    codePanelMode.style.display = 'flex';
    componentNameEl.textContent = getComponentName(component);

    // Hide CSS/JS tabs in component mode (only HTML editing)
    document.querySelectorAll('.code-panel-tab').forEach(t => {
      if (t.dataset.type === 'html') {
        t.style.display = '';
        t.classList.add('active');
      } else {
        t.style.display = 'none';
        t.classList.remove('active');
      }
    });
    currentCodeTab = 'html';

    // Open code panel
    codePanel.classList.add('open');
    btnCode.classList.add('active');

    if (!monacoInitialized) {
      initMonacoEditors();
      // Wait for Monaco to initialize, then set component HTML
      setTimeout(() => {
        htmlMonacoEditor.setValue(component.toHTML());
        setTimeout(() => htmlMonacoEditor.getAction('editor.action.formatDocument').run(), 50);

        // Show HTML container, hide others
        document.getElementById('monaco-html-container').style.display = 'block';
        document.getElementById('monaco-css-container').style.display = 'none';
        document.getElementById('monaco-js-container').style.display = 'none';

        htmlMonacoEditor.layout();
        htmlMonacoEditor.focus();
      }, 200);
    } else {
      htmlMonacoEditor.setValue(component.toHTML());
      setTimeout(() => htmlMonacoEditor.getAction('editor.action.formatDocument').run(), 50);

      // Show HTML container, hide others
      document.getElementById('monaco-html-container').style.display = 'block';
      document.getElementById('monaco-css-container').style.display = 'none';
      document.getElementById('monaco-js-container').style.display = 'none';

      htmlMonacoEditor.layout();
      htmlMonacoEditor.focus();
    }

    setTimeout(() => editor.refresh(), 50);
  }

  // Get a friendly name for a component
  function getComponentName(component) {
    const type = component.get('type');
    const tagName = component.get('tagName') || 'div';
    const classes = component.getClasses().slice(0, 2).join('.');
    const id = component.getId();

    if (id) return `#${id}`;
    if (classes) return `${tagName}.${classes}`;
    if (type && type !== 'default') return type;
    return tagName;
  }

  // Exit component mode and return to full page mode
  function exitComponentMode() {
    const wasInComponentMode = isComponentMode;
    isComponentMode = false;
    editingComponent = null;
    codePanelMode.style.display = 'none';

    // Show all tabs again
    document.querySelectorAll('.code-panel-tab').forEach(t => {
      t.style.display = '';
    });

    // Only sync if we were in component mode and Monaco is initialized
    if (wasInComponentMode && monacoInitialized) {
      syncGrapeJSToMonaco();
    }
  }

  function scheduleCodeUpdate() {
    statusEl.textContent = 'Modified...';
    statusEl.className = 'code-status modified';

    if (codeDebounceTimer) {
      clearTimeout(codeDebounceTimer);
    }
    codeDebounceTimer = setTimeout(updatePreviewFromCode, 200);
  }

  // Format all editors
  async function formatAllCode() {
    if (!monacoInitialized) return;
    await htmlMonacoEditor.getAction('editor.action.formatDocument').run();
    await cssMonacoEditor.getAction('editor.action.formatDocument').run();
    await jsMonacoEditor.getAction('editor.action.formatDocument').run();
  }

  // Schedule JS update (doesn't update GrapeJS preview, just marks as modified)
  function scheduleJsUpdate() {
    statusEl.textContent = 'Modified...';
    statusEl.className = 'code-status modified';

    if (codeDebounceTimer) {
      clearTimeout(codeDebounceTimer);
    }
    codeDebounceTimer = setTimeout(() => {
      injectJsIntoCanvas();
      statusEl.textContent = 'Synced';
      statusEl.className = 'code-status synced';
    }, 200);
  }

  // Inject JS into GrapeJS canvas iframe
  function injectJsIntoCanvas() {
    if (!monacoInitialized) return;

    const jsCode = jsMonacoEditor.getValue();
    const frame = editor.Canvas.getFrameEl();
    if (!frame || !frame.contentDocument) return;

    // Remove existing injected script
    const existingScript = frame.contentDocument.getElementById('active-canvas-custom-js');
    if (existingScript) {
      existingScript.remove();
    }

    // Inject new script
    if (jsCode.trim()) {
      const script = frame.contentDocument.createElement('script');
      script.id = 'active-canvas-custom-js';
      script.textContent = jsCode;
      frame.contentDocument.body.appendChild(script);
    }
  }

  // Add keyboard shortcuts to Monaco editors
  function addMonacoCommands(monacoEditor) {
    // Ctrl+S / Cmd+S to format and apply
    monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, async () => {
      if (codeDebounceTimer) {
        clearTimeout(codeDebounceTimer);
      }
      await formatAllCode();
      updatePreviewFromCode();
      showToast('Formatted and applied', 'success');
    });

    // Ctrl+Shift+F / Cmd+Shift+F to format
    monacoEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyF, () => {
      monacoEditor.getAction('editor.action.formatDocument').run();
    });
  }

  // Toggle code panel
  function toggleCodePanel() {
    const isOpen = codePanel.classList.toggle('open');
    btnCode.classList.toggle('active', isOpen);

    if (isOpen) {
      // Exit component mode when opening via main button
      exitComponentMode();

      if (!monacoInitialized) {
        initMonacoEditors();
      } else {
        syncGrapeJSToMonaco();
      }
      setTimeout(() => {
        if (htmlMonacoEditor) htmlMonacoEditor.layout();
        if (cssMonacoEditor) cssMonacoEditor.layout();
        if (jsMonacoEditor) jsMonacoEditor.layout();
        editor.refresh();
      }, 50);
    } else {
      exitComponentMode();
      editor.refresh();
    }
  }

  // Code panel button
  btnCode.addEventListener('click', toggleCodePanel);

  // Close button
  document.getElementById('code-close').addEventListener('click', () => {
    exitComponentMode();
    codePanel.classList.remove('open');
    btnCode.classList.remove('active');
    editor.refresh();
  });

  // Full Page button (exit component mode)
  document.getElementById('code-full-page').addEventListener('click', () => {
    exitComponentMode();
  });

  // Tab switching in code panel
  document.querySelectorAll('.code-panel-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      currentCodeTab = this.dataset.type;
      document.querySelectorAll('.code-panel-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');

      const htmlContainer = document.getElementById('monaco-html-container');
      const cssContainer = document.getElementById('monaco-css-container');
      const jsContainer = document.getElementById('monaco-js-container');

      // Hide all containers
      htmlContainer.style.display = 'none';
      cssContainer.style.display = 'none';
      jsContainer.style.display = 'none';

      // Show and focus the selected editor
      if (currentCodeTab === 'html') {
        htmlContainer.style.display = 'block';
        if (htmlMonacoEditor) {
          htmlMonacoEditor.layout();
          htmlMonacoEditor.focus();
        }
      } else if (currentCodeTab === 'css') {
        cssContainer.style.display = 'block';
        if (cssMonacoEditor) {
          cssMonacoEditor.layout();
          cssMonacoEditor.focus();
        }
      } else if (currentCodeTab === 'js') {
        jsContainer.style.display = 'block';
        if (jsMonacoEditor) {
          jsMonacoEditor.layout();
          jsMonacoEditor.focus();
        }
      }
    });
  });

  // Apply button
  document.getElementById('code-apply').addEventListener('click', async () => {
    if (codeDebounceTimer) {
      clearTimeout(codeDebounceTimer);
    }
    await formatAllCode();
    updatePreviewFromCode();
    showToast('Formatted and applied', 'success');
  });

  // Format button
  document.getElementById('code-format').addEventListener('click', async () => {
    await formatAllCode();
  });

  // Resize functionality
  const resizeHandle = document.getElementById('code-panel-resize');
  let isResizing = false;
  let startY = 0;
  let startHeight = 0;

  resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    startY = e.clientY;
    startHeight = codePanel.offsetHeight;
    document.body.style.cursor = 'ns-resize';
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    const deltaY = startY - e.clientY;
    const newHeight = Math.min(Math.max(startHeight + deltaY, 150), window.innerHeight * 0.7);
    codePanel.style.height = newHeight + 'px';
    if (htmlMonacoEditor) htmlMonacoEditor.layout();
    if (cssMonacoEditor) cssMonacoEditor.layout();
    if (jsMonacoEditor) jsMonacoEditor.layout();
    editor.refresh();
  });

  document.addEventListener('mouseup', () => {
    if (isResizing) {
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });

  // --- Save ---
  document.getElementById('btn-save').addEventListener('click', saveContent);

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      saveContent();
    }
  });

  // Auto-save every 60 seconds
  let autoSaveInterval = setInterval(() => {
    saveContent(true);
  }, 60000);

  // --- Functions ---

  function saveContent(isAutoSave = false) {
    const saveBtn = document.getElementById('btn-save');
    saveBtn.disabled = true;

    if (!isAutoSave) {
      showLoading(true);
    }

    const html = editor.getHtml();
    const css = editor.getCss();
    const js = jsMonacoEditor ? jsMonacoEditor.getValue() : (existingJs || '');
    const components = JSON.stringify(editor.getComponents());

    fetch(saveUrl, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        page: {
          content: html,
          content_css: css,
          content_js: js,
          content_components: components
        }
      })
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        showToast(isAutoSave ? 'Auto-saved' : 'Page saved successfully', 'success');
      } else {
        showToast(result.errors ? result.errors.join(', ') : 'Save failed', 'error');
      }
    })
    .catch(error => {
      showToast('Save failed', 'error');
      console.error('Save error:', error);
    })
    .finally(() => {
      saveBtn.disabled = false;
      showLoading(false);
    });
  }

  function loadAssets() {
    fetch(mediaUrl, {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(result => {
      if (result.data) {
        editor.AssetManager.add(result.data);
      }
    })
    .catch(error => {
      console.error('Failed to load assets:', error);
    });
  }

  function showToast(message, type) {
    const toast = document.getElementById('editor-toast');
    toast.textContent = message;
    toast.className = 'editor-toast show ' + type;

    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }

  function showLoading(show) {
    const loading = document.getElementById('editor-loading');
    if (show) {
      loading.classList.remove('hidden');
    } else {
      loading.classList.add('hidden');
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function addCustomBlocks(editor) {
    const bm = editor.BlockManager;

    // --- Layout Blocks ---
    bm.add('section', {
      label: 'Section',
      category: 'Layout',
      content: '<section class="py-16 px-4"><div class="max-w-6xl mx-auto"></div></section>',
      attributes: { class: 'gjs-fonts gjs-f-b1' }
    });

    bm.add('container', {
      label: 'Container',
      category: 'Layout',
      content: '<div class="max-w-6xl mx-auto px-4"></div>',
      attributes: { class: 'gjs-fonts gjs-f-b1' }
    });

    bm.add('div', {
      label: 'Div Block',
      category: 'Layout',
      content: '<div></div>',
      attributes: { class: 'gjs-fonts gjs-f-b1' }
    });

    // --- Hero Sections ---
    bm.add('hero-simple', {
      label: 'Hero Simple',
      category: 'Sections',
      content: `
        <section class="py-20 px-4 bg-gray-900 text-white text-center">
          <div class="max-w-4xl mx-auto">
            <h1 class="text-5xl font-bold mb-6">Welcome to Your Site</h1>
            <p class="text-xl text-gray-300 mb-8">A beautiful subtitle that describes what you do and why visitors should care.</p>
            <a href="#" class="inline-block bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700">Get Started</a>
          </div>
        </section>
      `
    });

    bm.add('hero-split', {
      label: 'Hero Split',
      category: 'Sections',
      content: `
        <section class="py-16 px-4">
          <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-12 items-center">
            <div>
              <h1 class="text-4xl font-bold mb-4">Build Something Amazing</h1>
              <p class="text-lg text-gray-600 mb-6">Create beautiful, responsive websites without writing code. Drag, drop, and customize.</p>
              <a href="#" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold">Learn More</a>
            </div>
            <div class="bg-gray-200 rounded-lg aspect-video flex items-center justify-center">
              <span class="text-gray-500">Image Placeholder</span>
            </div>
          </div>
        </section>
      `
    });

    // --- Feature Sections ---
    bm.add('features-grid', {
      label: 'Features Grid',
      category: 'Sections',
      content: `
        <section class="py-16 px-4 bg-gray-50">
          <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Features</h2>
            <div class="grid md:grid-cols-3 gap-8">
              <div class="text-center p-6">
                <div class="w-12 h-12 bg-blue-600 rounded-lg mx-auto mb-4"></div>
                <h3 class="text-xl font-semibold mb-2">Feature One</h3>
                <p class="text-gray-600">Description of this amazing feature and why it matters to your users.</p>
              </div>
              <div class="text-center p-6">
                <div class="w-12 h-12 bg-blue-600 rounded-lg mx-auto mb-4"></div>
                <h3 class="text-xl font-semibold mb-2">Feature Two</h3>
                <p class="text-gray-600">Description of this amazing feature and why it matters to your users.</p>
              </div>
              <div class="text-center p-6">
                <div class="w-12 h-12 bg-blue-600 rounded-lg mx-auto mb-4"></div>
                <h3 class="text-xl font-semibold mb-2">Feature Three</h3>
                <p class="text-gray-600">Description of this amazing feature and why it matters to your users.</p>
              </div>
            </div>
          </div>
        </section>
      `
    });

    // --- Cards ---
    bm.add('card', {
      label: 'Card',
      category: 'Components',
      content: `
        <div class="bg-white rounded-lg shadow-md overflow-hidden max-w-sm">
          <div class="bg-gray-200 h-48 flex items-center justify-center">
            <span class="text-gray-500">Image</span>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-semibold mb-2">Card Title</h3>
            <p class="text-gray-600 mb-4">Some description text for this card component.</p>
            <a href="#" class="text-blue-600 font-semibold">Learn more &rarr;</a>
          </div>
        </div>
      `
    });

    bm.add('cards-row', {
      label: 'Cards Row',
      category: 'Sections',
      content: `
        <section class="py-16 px-4">
          <div class="max-w-6xl mx-auto grid md:grid-cols-3 gap-8">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
              <div class="bg-gray-200 h-48 flex items-center justify-center">
                <span class="text-gray-500">Image</span>
              </div>
              <div class="p-6">
                <h3 class="text-xl font-semibold mb-2">Card One</h3>
                <p class="text-gray-600">Description text for this card.</p>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
              <div class="bg-gray-200 h-48 flex items-center justify-center">
                <span class="text-gray-500">Image</span>
              </div>
              <div class="p-6">
                <h3 class="text-xl font-semibold mb-2">Card Two</h3>
                <p class="text-gray-600">Description text for this card.</p>
              </div>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
              <div class="bg-gray-200 h-48 flex items-center justify-center">
                <span class="text-gray-500">Image</span>
              </div>
              <div class="p-6">
                <h3 class="text-xl font-semibold mb-2">Card Three</h3>
                <p class="text-gray-600">Description text for this card.</p>
              </div>
            </div>
          </div>
        </section>
      `
    });

    // --- CTA Sections ---
    bm.add('cta-simple', {
      label: 'CTA Section',
      category: 'Sections',
      content: `
        <section class="py-16 px-4 bg-blue-600 text-white text-center">
          <div class="max-w-3xl mx-auto">
            <h2 class="text-3xl font-bold mb-4">Ready to Get Started?</h2>
            <p class="text-blue-100 mb-8">Join thousands of satisfied customers using our product.</p>
            <a href="#" class="inline-block bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100">Start Free Trial</a>
          </div>
        </section>
      `
    });

    // --- Testimonials ---
    bm.add('testimonial', {
      label: 'Testimonial',
      category: 'Components',
      content: `
        <div class="bg-white p-8 rounded-lg shadow-md max-w-md">
          <p class="text-gray-600 mb-6 italic">"This product has completely transformed how we work. Highly recommended!"</p>
          <div class="flex items-center">
            <div class="w-12 h-12 bg-gray-300 rounded-full mr-4"></div>
            <div>
              <div class="font-semibold">John Doe</div>
              <div class="text-gray-500 text-sm">CEO, Company</div>
            </div>
          </div>
        </div>
      `
    });

    // --- Footer ---
    bm.add('footer-simple', {
      label: 'Footer',
      category: 'Sections',
      content: `
        <footer class="py-8 px-4 bg-gray-900 text-white">
          <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="text-xl font-bold mb-4 md:mb-0">YourBrand</div>
            <nav class="flex gap-6 mb-4 md:mb-0">
              <a href="#" class="text-gray-400 hover:text-white">Home</a>
              <a href="#" class="text-gray-400 hover:text-white">About</a>
              <a href="#" class="text-gray-400 hover:text-white">Services</a>
              <a href="#" class="text-gray-400 hover:text-white">Contact</a>
            </nav>
            <div class="text-gray-400 text-sm">&copy; 2024 YourBrand. All rights reserved.</div>
          </div>
        </footer>
      `
    });

    // --- Navigation ---
    bm.add('navbar', {
      label: 'Navbar',
      category: 'Navigation',
      content: `
        <nav class="py-4 px-4 bg-white shadow-sm">
          <div class="max-w-6xl mx-auto flex justify-between items-center">
            <a href="#" class="text-xl font-bold">YourBrand</a>
            <div class="flex gap-6">
              <a href="#" class="text-gray-600 hover:text-gray-900">Home</a>
              <a href="#" class="text-gray-600 hover:text-gray-900">About</a>
              <a href="#" class="text-gray-600 hover:text-gray-900">Services</a>
              <a href="#" class="text-gray-600 hover:text-gray-900">Contact</a>
            </div>
            <a href="#" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Sign Up</a>
          </div>
        </nav>
      `
    });

    // --- Pricing ---
    bm.add('pricing-card', {
      label: 'Pricing Card',
      category: 'Components',
      content: `
        <div class="bg-white rounded-lg shadow-md p-8 text-center max-w-sm">
          <h3 class="text-xl font-semibold mb-2">Pro Plan</h3>
          <div class="text-4xl font-bold mb-4">$29<span class="text-lg text-gray-500">/mo</span></div>
          <ul class="text-gray-600 mb-6 space-y-2">
            <li>Unlimited Projects</li>
            <li>Priority Support</li>
            <li>Advanced Analytics</li>
            <li>Custom Domain</li>
          </ul>
          <a href="#" class="block bg-blue-600 text-white py-3 rounded-lg font-semibold">Get Started</a>
        </div>
      `
    });

    // --- Contact Form ---
    bm.add('contact-form', {
      label: 'Contact Form',
      category: 'Forms',
      content: `
        <form class="max-w-lg mx-auto p-8 bg-white rounded-lg shadow-md">
          <h3 class="text-2xl font-bold mb-6">Contact Us</h3>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-semibold mb-2">Name</label>
            <input type="text" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your name">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-semibold mb-2">Email</label>
            <input type="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com">
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-semibold mb-2">Message</label>
            <textarea class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 h-32" placeholder="Your message"></textarea>
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Send Message</button>
        </form>
      `
    });

    // --- Newsletter ---
    bm.add('newsletter', {
      label: 'Newsletter',
      category: 'Forms',
      content: `
        <section class="py-12 px-4 bg-gray-100">
          <div class="max-w-xl mx-auto text-center">
            <h3 class="text-2xl font-bold mb-4">Subscribe to Our Newsletter</h3>
            <p class="text-gray-600 mb-6">Get the latest updates delivered to your inbox.</p>
            <form class="flex gap-2">
              <input type="email" class="flex-1 px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com">
              <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">Subscribe</button>
            </form>
          </div>
        </section>
      `
    });

    // --- FAQ ---
    bm.add('faq', {
      label: 'FAQ Section',
      category: 'Sections',
      content: `
        <section class="py-16 px-4">
          <div class="max-w-3xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Frequently Asked Questions</h2>
            <div class="space-y-4">
              <details class="bg-white rounded-lg shadow-md">
                <summary class="px-6 py-4 font-semibold cursor-pointer">What is your return policy?</summary>
                <p class="px-6 pb-4 text-gray-600">We offer a 30-day money-back guarantee on all purchases. Simply contact our support team for a full refund.</p>
              </details>
              <details class="bg-white rounded-lg shadow-md">
                <summary class="px-6 py-4 font-semibold cursor-pointer">How do I get started?</summary>
                <p class="px-6 pb-4 text-gray-600">Sign up for a free account and follow our quick start guide to begin using our platform in minutes.</p>
              </details>
              <details class="bg-white rounded-lg shadow-md">
                <summary class="px-6 py-4 font-semibold cursor-pointer">Do you offer customer support?</summary>
                <p class="px-6 pb-4 text-gray-600">Yes! We have 24/7 customer support available via chat, email, and phone for all paid plans.</p>
              </details>
            </div>
          </div>
        </section>
      `
    });
  }
});
</script>
