<!-- Editor Header -->
<header class="editor-header">
  <div class="editor-header-left">
    <%= link_to admin_pages_path, class: "editor-logo" do %>
      <div class="editor-logo-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12 2 2 7 12 12 22 7 12 2"/>
          <polyline points="2 17 12 22 22 17"/>
          <polyline points="2 12 12 17 22 12"/>
        </svg>
      </div>
    <% end %>
    <%= link_to admin_page_path(@page), class: "editor-back" do %>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
      Back
    <% end %>
    <div class="header-separator"></div>
    <div class="editor-title"><%= @page.title %></div>
  </div>

  <div class="editor-header-center">
    <button class="device-btn active" data-device="desktop" title="Desktop">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
        <line x1="8" y1="21" x2="16" y2="21"/>
        <line x1="12" y1="17" x2="12" y2="21"/>
      </svg>
    </button>
    <button class="device-btn" data-device="tablet" title="Tablet">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
        <line x1="12" y1="18" x2="12.01" y2="18"/>
      </svg>
    </button>
    <button class="device-btn" data-device="mobile" title="Mobile">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
        <line x1="12" y1="18" x2="12.01" y2="18"/>
      </svg>
    </button>
  </div>

  <div class="editor-header-right">
    <button class="header-btn header-btn-secondary" id="btn-toggle-left" title="Toggle Blocks Panel">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <line x1="9" y1="3" x2="9" y2="21"/>
      </svg>
    </button>
    <button class="header-btn header-btn-secondary" id="btn-toggle-ai" title="Toggle AI Assistant">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 8V4H8"/>
        <rect width="16" height="12" x="4" y="8" rx="2"/>
        <path d="M2 14h2"/>
        <path d="M20 14h2"/>
        <path d="M15 13v2"/>
        <path d="M9 13v2"/>
      </svg>
    </button>
    <button class="header-btn header-btn-secondary" id="btn-toggle-right" title="Toggle Styles Panel">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <line x1="15" y1="3" x2="15" y2="21"/>
      </svg>
    </button>
    <div class="header-separator"></div>
    <button class="header-btn header-btn-secondary" id="btn-undo" title="Undo (Ctrl+Z)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 7v6h6"/>
        <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
      </svg>
    </button>
    <button class="header-btn header-btn-secondary" id="btn-redo" title="Redo (Ctrl+Y)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 7v6h-6"/>
        <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
      </svg>
    </button>
    <button class="header-btn header-btn-secondary" id="btn-code" title="View Code (Ctrl+E)">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="16 18 22 12 16 6"/>
        <polyline points="8 6 2 12 8 18"/>
      </svg>
      Code
    </button>
    <button class="header-btn header-btn-primary" id="btn-save">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
        <polyline points="17 21 17 13 7 13 7 21"/>
        <polyline points="7 3 7 8 15 8"/>
      </svg>
      Save
    </button>
  </div>
</header>

<!-- Main Editor -->
<div class="editor-wrapper">
  <div class="editor-main">
    <div class="editor-container">
      <!-- Left Panel: Blocks -->
      <div class="editor-panel-left collapsed" id="panel-left">
        <div class="panel-tabs">
          <button class="panel-tab active" data-panel="blocks">Blocks</button>
          <button class="panel-tab" data-panel="assets">Assets</button>
          <button class="panel-tab" data-panel="layers">Layers</button>
        </div>
        <div class="panel-content">
          <div id="blocks-container"></div>
          <div id="assets-container" style="display: none;">
            <div class="assets-panel">
              <div class="assets-toolbar">
                <button class="assets-upload-btn" id="btn-upload-asset" title="Upload new image">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  Upload
                </button>
                <button class="assets-refresh-btn" id="btn-refresh-assets" title="Refresh assets">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"/>
                    <polyline points="1 20 1 14 7 14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                  </svg>
                </button>
              </div>
              <div class="assets-grid" id="assets-grid">
                <div class="assets-loading">Loading assets...</div>
              </div>
              <input type="file" id="asset-upload-input" accept="image/*" multiple style="display: none;">
            </div>
          </div>
          <div id="layers-container" style="display: none;"></div>
        </div>
      </div>

      <!-- AI Panel (separate from left panel) -->
      <div class="editor-panel-ai collapsed" id="panel-ai">
        <div class="panel-header">
          <span class="panel-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8V4H8"/>
              <rect width="16" height="12" x="4" y="8" rx="2"/>
              <path d="M2 14h2"/>
              <path d="M20 14h2"/>
              <path d="M15 13v2"/>
              <path d="M9 13v2"/>
            </svg>
            AI Assistant
          </span>
          <button class="panel-close-btn" id="btn-close-ai" title="Close">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="panel-content">
          <div class="ai-panel">
            <div class="ai-mode-selector">
              <h4>Mode</h4>
              <div class="ai-mode-options">
                <button class="ai-mode-btn active" data-mode="page">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="9" y1="21" x2="9" y2="9"/>
                  </svg>
                  <span>Whole Page</span>
                </button>
                <button class="ai-mode-btn" data-mode="element">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  </svg>
                  <span>Selected Element</span>
                </button>
              </div>
            </div>
            <div class="ai-element-info" id="ai-element-info" style="display: none;">
              <div class="ai-element-badge">
                <span id="ai-selected-element">No element selected</span>
                <button class="ai-element-select-btn" id="ai-select-element" title="Click to select an element">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                    <path d="M13 13l6 6"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="ai-prompt-area">
              <textarea id="ai-prompt" placeholder="Describe what you want to create or change..." rows="4"></textarea>
              <button class="ai-generate-btn" id="btn-ai-generate" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                Generate
              </button>
            </div>
            <div class="ai-coming-soon">
              <div class="ai-coming-soon-badge">Coming Soon</div>
              <p>AI-powered design generation will be available in a future update.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Canvas -->
      <div class="editor-canvas">
        <div id="gjs"></div>
        <button class="add-section-btn" id="btn-add-section" title="Add a new section">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Section
        </button>
      </div>

      <!-- Right Panel: Styles/Settings -->
      <div class="editor-panel-right collapsed" id="panel-right">
        <div class="panel-tabs">
          <button class="panel-tab active" data-panel="styles">Styles</button>
          <button class="panel-tab" data-panel="settings">Settings</button>
        </div>
        <div class="panel-content">
          <div id="styles-container"></div>
          <div id="traits-container" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Panel: Code Editor -->
  <div class="editor-code-panel" id="code-panel">
    <div class="code-panel-header">
      <div class="code-panel-tabs">
        <button class="code-panel-tab active" data-type="html">HTML</button>
        <button class="code-panel-tab" data-type="css">CSS</button>
        <button class="code-panel-tab" data-type="js">JavaScript</button>
      </div>
      <div class="code-panel-mode" id="code-panel-mode" style="display: none;">
        <span class="mode-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          </svg>
          <span id="component-name">Component</span>
        </span>
        <button class="code-panel-btn" id="code-full-page" title="Switch to full page">Full Page</button>
      </div>
      <div class="code-panel-actions">
        <span id="code-status" class="code-status synced">Synced</span>
        <button class="code-panel-btn" id="code-format" title="Format (Ctrl+Shift+F)">Format</button>
        <button class="code-panel-btn primary" id="code-apply" title="Apply (Ctrl+S)">Apply</button>
        <button class="code-panel-btn" id="code-close" title="Close">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div class="code-panel-resize" id="code-panel-resize"></div>
    <div class="code-panel-content">
      <div id="monaco-html-container" class="monaco-container"></div>
      <div id="monaco-css-container" class="monaco-container" style="display: none;"></div>
      <div id="monaco-js-container" class="monaco-container" style="display: none;"></div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="editor-toast" class="editor-toast"></div>

<!-- Loading Overlay -->
<div id="editor-loading" class="editor-loading hidden">
  <div class="editor-loading-spinner"></div>
</div>

<%= stylesheet_link_tag "active_canvas/editor", media: "all" %>

<!-- Editor Configuration -->
<script>
  window.ActiveCanvasEditor = {
    config: {
      pageId: <%= @page.id %>,
      saveUrl: '<%= save_editor_admin_page_path(@page) %>',
      mediaUrl: '<%= admin_media_path(format: :json) %>',
      uploadUrl: '<%= admin_media_path %>',
      content: <%= raw (@page.content || '').to_json %>,
      contentCss: <%= raw (@page.content_css || '').to_json %>,
      contentJs: <%= raw (@page.content_js || '').to_json %>,
      contentComponents: <%= raw (@page.content_components || '').to_json %>,
      cssFramework: '<%= ActiveCanvas::Setting.css_framework %>',
      cssFrameworkUrl: <%= raw (ActiveCanvas::Setting.css_framework_url || '').to_json %>,
      cssFrameworkType: '<%= ActiveCanvas::Setting.css_framework_type %>',
      globalCss: <%= raw (ActiveCanvas::Setting.global_css || '').to_json %>,
      globalJs: <%= raw (ActiveCanvas::Setting.global_js || '').to_json %>
    }
  };
</script>

<!-- Editor JavaScript -->
<%= javascript_include_tag "active_canvas/editor" %>

<!-- AI Panel JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // AI Mode selector
  const aiModeButtons = document.querySelectorAll('.ai-mode-btn');
  const aiElementInfo = document.getElementById('ai-element-info');
  const aiSelectedElement = document.getElementById('ai-selected-element');
  const aiSelectElementBtn = document.getElementById('ai-select-element');
  const aiPrompt = document.getElementById('ai-prompt');
  const aiGenerateBtn = document.getElementById('btn-ai-generate');
  let aiMode = 'page';

  // Mode switching
  aiModeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      aiModeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      aiMode = this.dataset.mode;

      if (aiMode === 'element') {
        aiElementInfo.style.display = 'block';
        updateSelectedElementDisplay();
      } else {
        aiElementInfo.style.display = 'none';
      }
    });
  });

  // Enable/disable generate button based on prompt
  if (aiPrompt) {
    aiPrompt.addEventListener('input', function() {
      aiGenerateBtn.disabled = this.value.trim().length === 0;
    });
  }

  // Update display when element is selected in editor
  function updateSelectedElementDisplay() {
    if (!window.ActiveCanvasEditor.instance) return;
    const selected = window.ActiveCanvasEditor.instance.getSelected();
    if (selected) {
      const tagName = selected.get('tagName') || 'div';
      const classes = selected.getClasses().slice(0, 2).join('.');
      const id = selected.getId();
      let name = tagName;
      if (id) name = `#${id}`;
      else if (classes) name = `${tagName}.${classes}`;
      aiSelectedElement.textContent = name;
    } else {
      aiSelectedElement.textContent = 'No element selected';
    }
  }

  // Listen for selection changes
  const checkEditor = setInterval(() => {
    if (window.ActiveCanvasEditor.instance) {
      clearInterval(checkEditor);
      window.ActiveCanvasEditor.instance.on('component:selected', updateSelectedElementDisplay);
      window.ActiveCanvasEditor.instance.on('component:deselected', updateSelectedElementDisplay);
    }
  }, 100);

  // Select element button - trigger selection mode
  if (aiSelectElementBtn) {
    aiSelectElementBtn.addEventListener('click', function() {
      if (window.ActiveCanvasEditor.instance) {
        // Close AI panel and focus on canvas
        const panelAi = document.getElementById('panel-ai');
        const btnToggleAi = document.getElementById('btn-toggle-ai');
        panelAi.classList.add('collapsed');
        btnToggleAi.classList.remove('active');

        window.ActiveCanvasEditor.showToast('Click on an element in the canvas to select it', 'success');
      }
    });
  }
});
</script>
